<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="In the last lab you used systems calls to write a few utilities. In this lab you will add some new system calls to xv6, which will help you understand how they work and will expose you to some of the">
<meta property="og:type" content="article">
<meta property="og:title" content="System Calls">
<meta property="og:url" content="http://example.com/2022/11/27/System-Calls/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="In the last lab you used systems calls to write a few utilities. In this lab you will add some new system calls to xv6, which will help you understand how they work and will expose you to some of the">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/11/27/System-Calls/syscalls.png">
<meta property="og:image" content="http://example.com/2022/11/27/System-Calls/sysandreturn.png">
<meta property="article:published_time" content="2022-11-27T07:44:22.000Z">
<meta property="article:modified_time" content="2022-11-27T09:32:24.845Z">
<meta property="article:author" content="Eureka">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/11/27/System-Calls/syscalls.png">


<link rel="canonical" href="http://example.com/2022/11/27/System-Calls/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2022/11/27/System-Calls/","path":"2022/11/27/System-Calls/","title":"System Calls"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>System Calls | Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">实验介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#System-Call-Tracing-moderate"><span class="nav-number">2.</span> <span class="nav-text">System Call Tracing(moderate)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.1.</span> <span class="nav-text">题目介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="nav-number">2.2.</span> <span class="nav-text">解题思路</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-number">2.2.1.</span> <span class="nav-text">上下文</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E4%BB%8E%E7%94%A8%E6%88%B7%E6%80%81%E4%BF%9D%E5%AD%98%E4%B8%8B%E6%9D%A5%E7%9A%84%E5%8F%82%E6%95%B0"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">获取从用户态保存下来的参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%93%AA%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">获取哪一个参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0%E4%B9%8B%E5%90%8E%E5%BA%94%E8%AF%A5%E5%AD%98%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C"><span class="nav-number">2.2.1.3.</span> <span class="nav-text">获取参数之后应该存放在哪里</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fork-%E6%8B%B7%E8%B4%9Dmask"><span class="nav-number">2.2.2.</span> <span class="nav-text">fork()拷贝mask</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8syscall-c%E4%B8%AD%E7%9A%84syscall-%E5%87%BD%E6%95%B0%E4%B8%AD%E5%AE%9E%E7%8E%B0trace%E7%9A%84%E8%BE%93%E5%87%BA"><span class="nav-number">2.2.3.</span> <span class="nav-text">在syscall.c中的syscall()函数中实现trace的输出</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">获取参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AEmask%E5%88%A4%E6%96%AD%E9%9C%80%E8%A6%81%E8%BF%BD%E8%B8%AA%E7%9A%84syscalls"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">根据mask判断需要追踪的syscalls</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AA%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">2.3.</span> <span class="nav-text">未解决的问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sysinfo-moderate"><span class="nav-number">3.</span> <span class="nav-text">Sysinfo(moderate)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E4%BB%8B%E7%BB%8D-1"><span class="nav-number">3.1.</span> <span class="nav-text">题目介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-1"><span class="nav-number">3.2.</span> <span class="nav-text">解题思路</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Eureka</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/27/System-Calls/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Eureka">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="System Calls | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          System Calls
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-11-27 15:44:22 / Modified: 17:32:24" itemprop="dateCreated datePublished" datetime="2022-11-27T15:44:22+08:00">2022-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/6-s081/" itemprop="url" rel="index"><span itemprop="name">6.s081</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>In the last lab you used systems calls to write a few utilities. In this lab you will add some new system calls to xv6, which will help you understand how they work and will expose you to some of the internals of the xv6 kernel. You will add more system calls in later labs.</p>
<span id="more"></span>
<h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>完成两个新的系统调用(syscalls)：trace, sysinfo，主要用于后续的debug<br>并且在此过程中加深对于xv6系统调用模型的理解</p>
<p>不得不说，做过了NJU的PA之后还是大有裨益的，至少在这里的trace的实现就给了我很大的启示<br>包括整个系统调用的过程的理解，还有编写trace的一些思路，都是之前在PA里面学到的</p>
<blockquote>
<p>不得不说6.s081还是非常beginner friendly的，基本把每一步需要在哪个文件里面完成一些什么功能都写的非常清楚了<br>相比之下，PA就有点谜语人了(笑，但是也正是因为这样，才引导我去把syscall的每一步分析清楚，加深了对于整个系统的理解，算是各有利弊吧</p>
</blockquote>
<h2 id="System-Call-Tracing-moderate"><a href="#System-Call-Tracing-moderate" class="headerlink" title="System Call Tracing(moderate)"></a>System Call Tracing(moderate)</h2><h3 id="题目介绍"><a href="#题目介绍" class="headerlink" title="题目介绍"></a>题目介绍</h3><p>在内核(kernel)中添加一个新的系统调用<code>trace</code>来帮助在后续的lab中debug<br>这个系统调用接受一个参数—<code>mask</code>，这个参数的每一个bit都指明了该系统调用是否需要追踪，比如如果需要追踪<code>fork</code>这个系统调用，那么就需要把<code>mask</code>的第<code>SYS_fork</code>置1<br><code>trace</code>的输出格式是这样的<code>&#123;pid&#125;: syscall &#123;syscall&#39;s name&#125; -&gt; &#123;return value&#125;</code></p>
<p>Some Hints</p>
<ul>
<li>向<code>Makefile</code>中的<code>UPROGS</code>变量中添加<code>$_Utrace</code>，这样在编译qemu的时候就会将trace加入编译中</li>
<li>在<code>user/user.h</code>中添加<code>trace</code>的函数声明；在<code>user/usys.pl</code>中添加<code>trace</code>的选项，这样在执行<code>user/usys.pl</code>生成<code>user/usys.S</code>的时候就会生成<code>trace</code>的相应的汇编代码(其实就是一小段ecall和ret的代码段)</li>
<li>在<code>kernel/sysproc.c</code>中添加<code>trace</code>的函数实现<code>sys_trace()</code>，这个函数接受从命令行传递的参数<code>mask</code>并且将其保存在定义在<code>kernel/proc.h</code>的<code>proc</code>结构体中</li>
<li>修改<code>fork()</code>，使其可以支持将<code>trace</code>的参数<code>mask</code>赋值给<code>child process</code></li>
<li>修改<code>kernel/syscall.c</code>中的<code>syscall()</code>函数，使其可以打印<code>trace</code>要求的输出</li>
</ul>
<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>讲义里面讲的已经非常清楚了，这里主要讲一下一些实现的细节</p>
<h4 id="上下文"><a href="#上下文" class="headerlink" title="上下文"></a>上下文</h4><p>在实现<code>sys_trace()</code>的时候，我们需要获取从command line中获得的trace系统调用的参数mask，并且将其保存在<code>proc</code>结构体中，要想完成这一过程需要解决如下几个问题</p>
<ol>
<li>如何获取从用户态传递过来的参数</li>
<li>应该获取哪一个参数</li>
<li>获取参数之后应该把它存放在哪里</li>
</ol>
<h5 id="获取从用户态保存下来的参数"><a href="#获取从用户态保存下来的参数" class="headerlink" title="获取从用户态保存下来的参数"></a>获取从用户态保存下来的参数</h5><p>我们知道，riscv在异常处理的时候会将参数存放在特定的register中</p>
<p><img src="/2022/11/27/System-Calls/syscalls.png" alt="ABI for syscalls"></p>
<p>通过参考<code>kernel/sysproc.c</code>中的其他系统调用，可以发现他们是使用<code>argint()</code>来获取参数的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sysproc.c</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  <span class="keyword">if</span> (argint(<span class="number">0</span>, &amp;n) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="built_in">exit</span>(n);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// not reached</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里，<code>sys_exit()</code>就通过<code>argint(0, &amp;n)</code>获取了<code>a0</code>寄存器的值，并且将其保存在变量<code>n</code>以供后续使用</p>
<p>至此，<strong>如何获取参数</strong>的问题就已经解决了</p>
<blockquote>
<p>调用<code>argint()</code>函数即可</p>
</blockquote>
<p>如果我们深挖一下，就可以发现<code>argint()</code>是定义在<code>kernel/syscall.c</code>中的，并且调用了<code>argraw()</code>来获取寄存器中的参数<br>并且，<code>argraw()</code>是从<code>proc</code>这个结构体来获取寄存器中的参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/syscall.c/argraw()</span></span><br><span class="line"><span class="comment">// kernel/syscall.c/argint()</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="type">static</span> uint64</span><br><span class="line"><span class="title function_">argraw</span><span class="params">(<span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  <span class="keyword">switch</span> (n)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a0;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a1;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a2;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a3;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a4;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a5;</span><br><span class="line">  &#125;</span><br><span class="line">  panic(<span class="string">&quot;argraw&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fetch the nth 32-bit system call argument.</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">argint</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> *ip)</span></span><br><span class="line">&#123;</span><br><span class="line">  *ip = argraw(n);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>kernel/proc.h</code>中的<code>proc</code>结构体则保存了一个process的所有状态，可以看到，对于寄存器的操作是通过访问一个叫做<code>trapframe</code>的结构体来完成的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.h/proc</span></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// p-&gt;lock must be held when using these:</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">procstate</span> <span class="title">state</span>;</span> <span class="comment">// Process state</span></span><br><span class="line">  <span class="type">void</span> *chan;           <span class="comment">// If non-zero, sleeping on chan</span></span><br><span class="line">  <span class="type">int</span> killed;           <span class="comment">// If non-zero, have been killed</span></span><br><span class="line">  <span class="type">int</span> xstate;           <span class="comment">// Exit status to be returned to parent&#x27;s wait</span></span><br><span class="line">  <span class="type">int</span> pid;              <span class="comment">// Process ID</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait_lock must be held when using this:</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">parent</span>;</span> <span class="comment">// Parent process</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// these are private to the process, so p-&gt;lock need not be held.</span></span><br><span class="line">  uint64 kstack;               <span class="comment">// Virtual address of kernel stack</span></span><br><span class="line">  uint64 sz;                   <span class="comment">// Size of process memory (bytes)</span></span><br><span class="line">  <span class="type">pagetable_t</span> pagetable;       <span class="comment">// User page table</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> *<span class="title">trapframe</span>;</span> <span class="comment">// data page for trampoline.S</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">context</span> <span class="title">context</span>;</span>      <span class="comment">// swtch() here to run process</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">ofile</span>[<span class="title">NOFILE</span>];</span>  <span class="comment">// Open files</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">cwd</span>;</span>           <span class="comment">// Current directory</span></span><br><span class="line">  <span class="type">char</span> name[<span class="number">16</span>];               <span class="comment">// Process name (debugging)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>trapframe</code>结构体中则保存了所有的寄存器状态</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.h/trapframe</span></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/*   0 */</span> uint64 kernel_satp;   <span class="comment">// kernel page table</span></span><br><span class="line">  <span class="comment">/*   8 */</span> uint64 kernel_sp;     <span class="comment">// top of process&#x27;s kernel stack</span></span><br><span class="line">  <span class="comment">/*  16 */</span> uint64 kernel_trap;   <span class="comment">// usertrap()</span></span><br><span class="line">  <span class="comment">/*  24 */</span> uint64 epc;           <span class="comment">// saved user program counter</span></span><br><span class="line">  <span class="comment">/*  32 */</span> uint64 kernel_hartid; <span class="comment">// saved kernel tp</span></span><br><span class="line">  <span class="comment">/*  40 */</span> uint64 ra;</span><br><span class="line">  <span class="comment">/*  48 */</span> uint64 sp;</span><br><span class="line">  <span class="comment">/*  56 */</span> uint64 gp;</span><br><span class="line">  <span class="comment">/*  64 */</span> uint64 tp;</span><br><span class="line">  <span class="comment">/*  72 */</span> uint64 t0;</span><br><span class="line">  <span class="comment">/*  80 */</span> uint64 t1;</span><br><span class="line">  <span class="comment">/*  88 */</span> uint64 t2;</span><br><span class="line">  <span class="comment">/*  96 */</span> uint64 s0;</span><br><span class="line">  <span class="comment">/* 104 */</span> uint64 s1;</span><br><span class="line">  <span class="comment">/* 112 */</span> uint64 a0;</span><br><span class="line">  <span class="comment">/* 120 */</span> uint64 a1;</span><br><span class="line">  <span class="comment">/* 128 */</span> uint64 a2;</span><br><span class="line">  <span class="comment">/* 136 */</span> uint64 a3;</span><br><span class="line">  <span class="comment">/* 144 */</span> uint64 a4;</span><br><span class="line">  <span class="comment">/* 152 */</span> uint64 a5;</span><br><span class="line">  <span class="comment">/* 160 */</span> uint64 a6;</span><br><span class="line">  <span class="comment">/* 168 */</span> uint64 a7;</span><br><span class="line">  <span class="comment">/* 176 */</span> uint64 s2;</span><br><span class="line">  <span class="comment">/* 184 */</span> uint64 s3;</span><br><span class="line">  <span class="comment">/* 192 */</span> uint64 s4;</span><br><span class="line">  <span class="comment">/* 200 */</span> uint64 s5;</span><br><span class="line">  <span class="comment">/* 208 */</span> uint64 s6;</span><br><span class="line">  <span class="comment">/* 216 */</span> uint64 s7;</span><br><span class="line">  <span class="comment">/* 224 */</span> uint64 s8;</span><br><span class="line">  <span class="comment">/* 232 */</span> uint64 s9;</span><br><span class="line">  <span class="comment">/* 240 */</span> uint64 s10;</span><br><span class="line">  <span class="comment">/* 248 */</span> uint64 s11;</span><br><span class="line">  <span class="comment">/* 256 */</span> uint64 t3;</span><br><span class="line">  <span class="comment">/* 264 */</span> uint64 t4;</span><br><span class="line">  <span class="comment">/* 272 */</span> uint64 t5;</span><br><span class="line">  <span class="comment">/* 280 */</span> uint64 t6;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>继续挖下去，可以发现，这些寄存器的上下文保存是通过汇编代码<code>(trampoline.S)</code>完成的</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kernel/trampoline.S</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># save the user registers in TRAPFRAME</span></span><br><span class="line"><span class="symbol">sd</span> ra, <span class="number">40</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">sp</span>, <span class="number">48</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> gp, <span class="number">56</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> tp, <span class="number">64</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> t0, <span class="number">72</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> t1, <span class="number">80</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> t2, <span class="number">88</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s0</span>, <span class="number">96</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s1</span>, <span class="number">104</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">a1</span>, <span class="number">120</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">a2</span>, <span class="number">128</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">a3</span>, <span class="number">136</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">a4</span>, <span class="number">144</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> a5, <span class="number">152</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> a6, <span class="number">160</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> a7, <span class="number">168</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s2</span>, <span class="number">176</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s3</span>, <span class="number">184</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s4</span>, <span class="number">192</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s5</span>, <span class="number">200</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s6</span>, <span class="number">208</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s7</span>, <span class="number">216</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s8</span>, <span class="number">224</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s9</span>, <span class="number">232</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s10</span>, <span class="number">240</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> <span class="built_in">s11</span>, <span class="number">248</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> t3, <span class="number">256</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> t4, <span class="number">264</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> t5, <span class="number">272</span>(a0)</span><br><span class="line"><span class="symbol">sd</span> t6, <span class="number">280</span>(a0)</span><br></pre></td></tr></table></figure>
<h5 id="获取哪一个参数"><a href="#获取哪一个参数" class="headerlink" title="获取哪一个参数"></a>获取哪一个参数</h5><p>一共就传递了一个参数，你说获取哪一个参数</p>
<blockquote>
<p>但是注意，这里的参数和命令行的参数略有不同，比如命令行的参数第一个是命令本身，而函数的参数传递则不是</p>
</blockquote>
<h5 id="获取参数之后应该存放在哪里"><a href="#获取参数之后应该存放在哪里" class="headerlink" title="获取参数之后应该存放在哪里"></a>获取参数之后应该存放在哪里</h5><p>显然，进程的状态都是保存在<code>proc</code>结构体中，那么这个新的状态应该放在哪里就显而易见了</p>
<h4 id="fork-拷贝mask"><a href="#fork-拷贝mask" class="headerlink" title="fork()拷贝mask"></a>fork()拷贝mask</h4><p>参考一下<code>fork()</code>是如何将其他的<code>process</code>状态从<code>parent</code>复制给<code>child</code>就可以了</p>
<blockquote>
<p>但是我不太理解为什么要fork一个child</p>
</blockquote>
<h4 id="在syscall-c中的syscall-函数中实现trace的输出"><a href="#在syscall-c中的syscall-函数中实现trace的输出" class="headerlink" title="在syscall.c中的syscall()函数中实现trace的输出"></a>在<code>syscall.c</code>中的<code>syscall()</code>函数中实现<code>trace</code>的输出</h4><p>在<code>syscall()</code>实现<code>trace</code>的输出，也就是在系统调用时输出<code>&#123;pid&#125;: syscall &#123;syscall name&#125; -&gt; &#123;return value&#125;</code><br>并且需要根据<code>mask</code>来确定需要追踪哪一些<code>syscalls</code></p>
<ol>
<li>如何获取pid, syscall name, return value的参数</li>
<li>如何根据mask来确定应该追踪哪些<code>syscalls</code></li>
</ol>
<h5 id="获取参数"><a href="#获取参数" class="headerlink" title="获取参数"></a>获取参数</h5><p>这个有了之前的经验就非常简单了，但是需要注意一下<code>Risc-v</code>的<code>ABI</code>是如何规定存放系统调用号和返回值的</p>
<blockquote>
<p>又要和我们的老朋友<code>$ man syscall</code>见面了~</p>
</blockquote>
<p><img src="/2022/11/27/System-Calls/sysandreturn.png" alt="syscall number and return value"></p>
<h5 id="根据mask判断需要追踪的syscalls"><a href="#根据mask判断需要追踪的syscalls" class="headerlink" title="根据mask判断需要追踪的syscalls"></a>根据mask判断需要追踪的syscalls</h5><p>想要解决这个问题其实非常简单，只需要根据mask和当前的系统调用号(syscall number)进行一些简单的逻辑运算就可以判断了</p>
<ol>
<li><code>mask</code>的每一位是怎么来的，或者说和<code>SYS_exit</code>这些系统调用号有什么关系</li>
<li>判断的逻辑是什么，是<strong>当</strong>我需要追踪这个系统调用(在<code>mask</code>中体现)<strong>且</strong>当前系统调用是我需要追踪的系统调用(在a7中体现)</li>
<li>哪一个逻辑运算是<strong>当且仅当</strong>的语义</li>
</ol>
<blockquote>
<p>友情鸣谢CASPP的<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/labs.html">Datalab</a>~</p>
</blockquote>
<h3 id="未解决的问题"><a href="#未解决的问题" class="headerlink" title="未解决的问题"></a>未解决的问题</h3><p><code>static uint64 (*syscalls[])(void) = &#123;&#125;;</code>一种神奇的语法，可以学习一下<br><!-- TODO: 叫你学一下！ --></p>
<h2 id="Sysinfo-moderate"><a href="#Sysinfo-moderate" class="headerlink" title="Sysinfo(moderate)"></a>Sysinfo(moderate)</h2><h3 id="题目介绍-1"><a href="#题目介绍-1" class="headerlink" title="题目介绍"></a>题目介绍</h3><h3 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h3>
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/11/26/Unix-utilities/" rel="prev" title="Unix utilities">
                  <i class="fa fa-chevron-left"></i> Unix utilities
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/12/23/CS61A-hw03/" rel="next" title="CS61A hw03">
                  CS61A hw03 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Eureka</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Symbols count total">8k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">7 mins.</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
